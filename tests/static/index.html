<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<head> 
<title>OJP/OTP Middleware API tester</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<link href="main.css" rel="stylesheet" type="text/css" />
</head>

<body>
<div id="content">
<h2><a href="https://github.com/openmove/ojp-middleware">OJP/OTP Middleware</a> API tester</h2>
<select id="xmls">
    <option disabled selected value>select a request...</option>
</select>
<a href="/list.json">xmls requests example files</a>
<br><br>
<label>REQUEST OJP:</label>
<br>
<form id="sendform">
<textarea id="xml_req" type="text" contenteditable="true" cols="120" rows="22"> 
</textarea>
<br />
<input type="submit" name="SEND REQUEST">
<br /><br />
<label>RESPONSE OJP:</label>
<br />
<textarea id="xml_res" cols="120" rows="22">
</textarea>

<div id="ojp_logs">
	<label>API-OJP REQUESTS LOGS: </label>
	<select id="ojp_logs_limit">
		<option value="2">last 2</option>
		<option selected value="5">last 5</option>
		<option value="10">last 10</option>
		<option value="50">last 50</option>
		<option value="100">last 100</option>
	</select>
	<div style="float:right">
		<a  id="logs_refresh" href="#">[refresh]</a> 
		<a href="" target="_blank">[open]</a>
	</div>
	<br />
	<textarea cols="80" rows="44">
	</textarea>
</div>
</form>
</div>

<script src="/jquery.min.js"></script>
<script src="/utils.js"></script>
<script src="/getconfig"></script>
<script>
const {host, port} = window.config['api-ojp'];

const apiOjpUrl = `${location.protocol}//${host}:${port}/ojp/`;

const $list = $('#xmls');

$.getJSON('/list.json', function( data ) {
    $.each( data, function( key, val ) {
        let name = val.replace('.xml','').replace('/xmls/','');
        $(`<option value="${val}">${name}</option>`).appendTo($list);
    });
})
.then(() => {
    $list.on('change', e => {
        e.preventDefault();
        $.get(e.target.value, xmldata => {
            $('#xml_req').text(comment(formatXml(xmldata)));
        })
    });
});

$("#sendform").submit(function(e){
    e.preventDefault();
    $('#xml_res').text('').addClass('loading');
    setTimeout(()=>{
		$.ajax({
			url: apiOjpUrl,
			type: 'POST',
			data: uncomment($('#xml_req').val()),
			contentType:"application/xml; charset=utf-8",
			success: function(data){
				//console.log('RETURN',data);
				$('#xml_res')
					.scrollTop(0)
					.text(formatXml(data))
					.removeClass('loading');
				$('#ojp_logs textarea').load(apiOjpUrl+'logs?limit='+$('#ojp_logs_limit').val())
			}
		})
	},300);

	return false;
});

$('#logs_refresh').on('click', e => {
	e.preventDefault();
	$('#ojp_logs textarea').empty().load(apiOjpUrl+'logs?limit='+$('#ojp_logs_limit').val())
})
.next('a').attr('href',apiOjpUrl+'logs?format=text')
</script> 

</body>
</html>
